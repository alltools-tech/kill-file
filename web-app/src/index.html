<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Universal File Converter</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body {padding:20px;}
.file-pill { display:inline-flex; align-items:center; margin:2px; padding:5px 10px; border:1px solid #ccc; border-radius:20px;}
.output-pill span { margin-right:8px;}
.preview-image { max-width:100%; max-height:400px; }
.preview-pdf { width:100%; height:500px; }
</style>
</head>
<body>
<h2>Universal File Converter</h2>

<!-- PDF → PDF/OCR -->
<div class="mb-3">
  <label>PDF → PDF/OCR</label><br>
  <input type="file" id="pdf2pdfInput" multiple>
  <select id="pdf2pdfQuality"><option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option></select>
  <input type="text" id="pdf2pdfLang" placeholder="OCR Lang e.g. en">
  <button class="btn btn-primary" id="pdf2pdfBtn">Convert</button>
  <span id="pdf2pdfSpin" style="display:none;">⏳</span>
  <div id="pdf2pdfOutput" class="mt-2"></div>
</div>

<!-- PDF → Image -->
<div class="mb-3">
  <label>PDF → Image</label><br>
  <input type="file" id="pdf2imgInput" multiple>
  <select id="pdf2imgFormat"><option value="png">PNG</option><option value="jpg">JPG</option></select>
  <select id="pdf2imgQuality"><option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option></select>
  <button class="btn btn-primary" id="pdf2imgBtn">Convert</button>
  <span id="pdf2imgSpin" style="display:none;">⏳</span>
  <div id="pdf2imgOutput" class="mt-2"></div>
</div>

<!-- Image → PDF/OCR -->
<div class="mb-3">
  <label>Image → PDF/OCR</label><br>
  <input type="file" id="img2pdfInput" multiple>
  <select id="img2pdfQuality"><option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option></select>
  <input type="text" id="img2pdfLang" placeholder="OCR Lang e.g. en">
  <button class="btn btn-primary" id="img2pdfBtn">Convert</button>
  <span id="img2pdfSpin" style="display:none;">⏳</span>
  <div id="img2pdfOutput" class="mt-2"></div>
</div>

<!-- Image → Image -->
<div class="mb-3">
  <label>Image → Image</label><br>
  <input type="file" id="img2imgInput" multiple>
  <select id="img2imgFormat"><option value="png">PNG</option><option value="jpg">JPG</option></select>
  <select id="img2imgQuality"><option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option></select>
  <button class="btn btn-primary" id="img2imgBtn">Convert</button>
  <span id="img2imgSpin" style="display:none;">⏳</span>
  <div id="img2imgOutput" class="mt-2"></div>
</div>

<!-- Office → PDF/OCR -->
<div class="mb-3">
  <label>Office → PDF/OCR</label><br>
  <input type="file" id="office2pdfInput" multiple>
  <select id="office2pdfQuality"><option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option></select>
  <input type="text" id="office2pdfLang" placeholder="OCR Lang e.g. en">
  <button class="btn btn-primary" id="office2pdfBtn">Convert</button>
  <span id="office2pdfSpin" style="display:none;">⏳</span>
  <div id="office2pdfOutput" class="mt-2"></div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-body" id="previewContent"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API_BASE="https://kill-file-2.onrender.com";

// --- API Helpers ---
async function uploadAndConvert(endpoint, files, formFields={}) {
  const formData=new FormData();
  Array.from(files).forEach(f=>formData.append('files',f));
  Object.entries(formFields).forEach(([k,v])=>formData.append(k,v));
  const resp=await fetch(endpoint,{method:'POST',body:formData});
  if(!resp.ok) throw new Error(await resp.text());
  return resp.json();
}

async function uploadAndConvertZip(endpoint, files, type, compress){
  const formData=new FormData();
  Array.from(files).forEach(f=>formData.append('files',f));
  formData.append('convert_type',type);
  formData.append('compress',compress);
  const resp=await fetch(endpoint,{method:'POST',body:formData});
  if(!resp.ok) throw new Error(await resp.text());
  return resp.blob();
}

// --- Preview ---
function showPreviewLink(url,name){
  const ext=name.split('.').pop().toLowerCase();
  let html='';
  if(['jpg','jpeg','png','bmp','svg','webp','avif','heic','heif'].includes(ext))
    html=`<img src="${url}" class="preview-image mb-2"><div>${name}</div>`;
  else if(ext==='pdf')
    html=`<iframe src="${url}" class="preview-pdf"></iframe><div>${name}</div>`;
  else html=`<div>No preview available for ${ext.toUpperCase()}.</div>`;
  document.getElementById('previewContent').innerHTML=html;
  new bootstrap.Modal(document.getElementById('previewModal')).show();
}

// --- Universal converter handler ---
function addConversion(buttonId,inputId,outputId,endpoint,extraFields=[]) {
  document.getElementById(buttonId).addEventListener('click',async()=>{
    const files=document.getElementById(inputId).files;
    const spinner=document.getElementById(buttonId.replace('Btn','Spin'));
    spinner.style.display='inline';
    let fields={};
    extraFields.forEach(f=>{
      const el=document.getElementById(f.id);
      if(el) fields[f.key]=el.value;
    });
    try{
      const result=await uploadAndConvert(API_BASE+endpoint,files,fields);
      spinner.style.display='none';
      let html=result.results.map(r=>`
        <span class="file-pill output-pill">
          <span>${r.filename}</span>
          <span class="badge bg-success text-dark">${Math.round(r.compressed_size/1024)} KB</span>
          <a class="btn btn-outline-success btn-sm btn-download" href="${r.download_url}" target="_blank">Download</a>
          <button class="btn btn-outline-primary btn-sm btn-preview" onclick="showPreviewLink('${r.download_url}','${r.filename}')">Preview</button>
        </span>
      `).join('');
      if(result.results.length>1) html+=`<button class="btn btn-outline-primary btn-sm mt-2" onclick="bulkZipDownload('${endpoint.replace('/convert/','')}', '${fields.compress||''}')">Download All as ZIP</button>`;
      document.getElementById(outputId).innerHTML=html;
    }catch(e){spinner.style.display='none'; alert('API Error:'+e.message);}
  });
}

// --- Bulk ZIP ---
function bulkZipDownload(type,compress){
  let files=[];
  switch(type){
    case 'pdf': files=[...document.getElementById('pdf2pdfInput').files]; break;
    case 'image': files=[...document.getElementById('pdf2imgInput').files,...document.getElementById('img2imgInput').files]; break;
    case 'office': files=[...document.getElementById('office2pdfInput').files]; break;
  }
  uploadAndConvertZip(API_BASE+'/convert/zip',files,type,compress)
    .then(blob=>{
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download="converted_files.zip";
      a.click();
    })
    .catch(e=>alert('ZIP API Error:'+e.message));
}

// --- Initialize all conversions ---
addConversion('pdf2pdfBtn','pdf2pdfInput','pdf2pdfOutput','/convert/pdf',[{id:'pdf2pdfQuality',key:'compress'},{id:'pdf2pdfLang',key:'ocr_lang'}]);
addConversion('pdf2imgBtn','pdf2imgInput','pdf2imgOutput','/convert/image',[{id:'pdf2imgFormat',key:'to_format'},{id:'pdf2imgQuality',key:'compress'}]);
addConversion('img2pdfBtn','img2pdfInput','img2pdfOutput','/convert/pdf',[{id:'img2pdfQuality',key:'compress'},{id:'img2pdfLang',key:'ocr_lang'}]);
addConversion('img2imgBtn','img2imgInput','img2imgOutput','/convert/image',[{id:'img2imgFormat',key:'to_format'},{id:'img2imgQuality',key:'compress'}]);
addConversion('office2pdfBtn','office2pdfInput','office2pdfOutput','/convert/office',[{id:'office2pdfQuality',key:'compress'},{id:'office2pdfLang',key:'ocr_lang'}]);

</script>
</body>
</html>